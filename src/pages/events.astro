---
import BaseLayout from "../layouts/BaseLayout.astro";
import {
  getEvents,
  getGlobalSettings,
  getPageSettings,
  portableTextToHtml,
  urlForImage,
} from "../lib/sanity";

type SanityImageAsset = {
  asset?: {
    url?: string;
    metadata?: {
      lqip?: string;
      dimensions?: { width?: number; height?: number };
    };
  };
};

type SanityEvent = {
  title: string;
  slug?: string;
  startDate?: string;
  endDate?: string;
  location?: string;
  partners?: string[];
  featured?: boolean;
  ctaLabel?: string;
  ctaUrl?: string;
  description?: unknown[];
  heroImage?: SanityImageAsset;
};

type ProcessedEvent = SanityEvent & {
  start: Date | null;
  end: Date | null;
  displayDate: string;
  location: string;
  descriptionHtml: string;
  heroImageUrl?: string;
  heroImageLqip?: string;
};

type CalendarCell = {
  day: string;
  isCurrentMonth: boolean;
  isToday?: boolean;
  holiday?: string;
};

const partners = [
  {
    name: "American Foundation for Suicide Prevention — Indiana Chapter",
    url: "https://afsp.org/Indiana",
    logo: "/images/webpages/AFSPlogo.webp",
    address: ["14350 Mundy Drive, Suite 800 #199", "Noblesville, IN 46060"],
    phone: "(317) 864-6074",
    email: "Indiana@afsp.org",
  },
  {
    name: "The Willow Center",
    url: "https://thewillowcenter.com",
    logo: "/images/webpages/WillowCenterlogo.webp",
    address: ["515 North Green Street, Suite 402", "Brownsburg, IN 46112"],
    phone: "(317) 852-3690",
    email: "ccotten@thewillowcenter.com",
  },
  {
    name: "Panoony's Pizza & Wings",
    url: "https://panoony.com",
    logo: "/images/webpages/panoonyslogo.webp",
    address: ["1447 E Main St, Ste C", "Brownsburg, IN 46112"],
    phone: "(317) 286-3500",
    email: "panoony@panoony.com",
  },
];

const NEETOCAL_EMBED = "https://neetocal.com/embed/catharsis-body-art";

const pageSettings = await getPageSettings("events");
const globalSettings = await getGlobalSettings();
const eventsRaw = (await getEvents()) as SanityEvent[];
const now = new Date();

const defaultLocation = globalSettings?.contact?.address
  ? globalSettings.contact.address.replace(/\n/g, ", ")
  : "Catharsis Body Art · Brownsburg, IN";

const formatDateRange = (
  startDate: Date | null,
  endDate: Date | null,
): string => {
  if (!startDate) return "Date TBD";
  const sameDay =
    endDate && startDate.toDateString() === endDate.toDateString();
  const baseOptions: Intl.DateTimeFormatOptions = {
    month: "short",
    day: "numeric",
  };
  const includeYear =
    startDate.getFullYear() !== now.getFullYear() ||
    (endDate && endDate.getFullYear() !== startDate.getFullYear());
  const startFormatter = new Intl.DateTimeFormat("en-US", {
    ...baseOptions,
    year: includeYear ? "numeric" : undefined,
  });
  if (!endDate) {
    return startFormatter.format(startDate);
  }
  const endFormatter = new Intl.DateTimeFormat("en-US", {
    ...baseOptions,
    year:
      includeYear || endDate.getFullYear() !== startDate.getFullYear()
        ? "numeric"
        : undefined,
  });
  if (sameDay) {
    return startFormatter.format(startDate);
  }
  return `${startFormatter.format(startDate)} – ${endFormatter.format(endDate)}`;
};

const events: ProcessedEvent[] = eventsRaw
  .map((event) => {
    const start = event.startDate ? new Date(event.startDate) : null;
    const end = event.endDate ? new Date(event.endDate) : null;
    const builder = urlForImage(event.heroImage);
    const heroImageUrl =
      builder?.width(1400).height(900).fit("crop").auto("format").url() ||
      event.heroImage?.asset?.url;
    return {
      ...event,
      start,
      end,
      displayDate: formatDateRange(start, end),
      location: event.location || defaultLocation,
      descriptionHtml: event.description?.length
        ? portableTextToHtml(event.description)
        : "",
      heroImageUrl,
      heroImageLqip: event.heroImage?.asset?.metadata?.lqip,
    };
  })
  .sort((a, b) => {
    if (!a.start || !b.start) return 0;
    return a.start.getTime() - b.start.getTime();
  });

const upcomingEvents: ProcessedEvent[] = events
  .filter((event) => {
    if (!event.start) return false;
    const comparisonDate = event.end || event.start;
    return comparisonDate >= now;
  })
  .sort((a, b) => {
    if (a.featured && !b.featured) return -1;
    if (!a.featured && b.featured) return 1;
    if (!a.start || !b.start) return 0;
    return a.start.getTime() - b.start.getTime();
  });

const recentEvents: ProcessedEvent[] = events
  .filter((event) => {
    if (!event.start) return false;
    const comparisonDate = event.end || event.start;
    return comparisonDate < now;
  })
  .slice(-3)
  .reverse();

const heroTitle = pageSettings?.heroTitle || "Schedule with NeetoCal";
const heroSubtitle =
  pageSettings?.heroSubtitle ||
  "Reserve your next tattoo or piercing session through our NeetoCal calendar. Pick a slot that works for you, and we’ll follow up with confirmation details.";
const heroCta = pageSettings?.cta;
const urlParams = new URLSearchParams(Astro.url.search);

let month = parseInt(urlParams.get("m") || "");
let year = parseInt(urlParams.get("y") || "");

if (isNaN(month) || month < 0 || month > 11) {
  month = now.getMonth();
}
if (isNaN(year) || year < 2020 || year > 2035) {
  year = now.getFullYear();
}

const firstDay = new Date(year, month, 1);
const lastDay = new Date(year, month + 1, 0);
const startDay = firstDay.getDay();
const daysInMonth = lastDay.getDate();

const holidays: Record<string, string> = {
  "1-1": "New Year's Day",
  "7-4": "Independence Day",
  "12-25": "Christmas Day",
};

const cells: CalendarCell[] = [];
for (let i = 0; i < startDay; i++) {
  cells.push({ day: "", isCurrentMonth: false });
}

for (let day = 1; day <= daysInMonth; day++) {
  const isToday =
    year === now.getFullYear() &&
    month === now.getMonth() &&
    day === now.getDate();
  const holidayKey = `${month + 1}-${day}`;
  const holiday = holidays[holidayKey];

  cells.push({
    day: day.toString(),
    isCurrentMonth: true,
    isToday,
    holiday,
  });
}

while (cells.length % 7 !== 0) {
  cells.push({ day: "", isCurrentMonth: false });
}

const prevMonth = month === 0 ? 11 : month - 1;
const prevYear = month === 0 ? year - 1 : year;
const nextMonth = month === 11 ? 0 : month + 1;
const nextYear = month === 11 ? year + 1 : year;

const monthNames = [
  "January",
  "February",
  "March",
  "April",
  "May",
  "June",
  "July",
  "August",
  "September",
  "October",
  "November",
  "December",
];
---

<BaseLayout
  title="Events"
  description="Studio happenings, specialty days, and community partners."
>
  <section class="section-block">
    <div class="section-header">
      <span class="section-label">Bookings</span>
      <div>
        <h1 class="section-heading">{heroTitle}</h1>
        <p class="section-subhead">{heroSubtitle}</p>
        {
          heroCta?.label && heroCta?.href && (
            <div class="section-actions">
              <a
                href={heroCta.href}
                class="btn-outline"
                target="_blank"
                rel="noopener noreferrer"
              >
                {heroCta.label}
              </a>
            </div>
          )
        }
      </div>
    </div>
    <div class="luxe-card">
      <div class="booking-embed">
        <iframe
          src={NEETOCAL_EMBED}
          title="NeetoCal booking"
          loading="lazy"
          class="booking-embed__iframe"
          allow="payment *; microphone *; camera *"></iframe>
      </div>
      <p class="booking-embed__note">
        Prefer to talk through your appointment first? Call us at <a
          href="tel:+13172867092">(317) 286-7092</a
        > or email
        <a href="mailto:info@catharsisba.com">info@catharsisba.com</a>.
      </p>
    </div>
  </section>

  <section class="section-block">
    <div class="section-header">
      <span class="section-label">Studio Events</span>
      <div>
        <h2 class="section-heading">Upcoming &amp; Featured</h2>
        <p class="section-subhead">
          Fresh drops, flash days, fundraisers, and collabs curated through
          Sanity. RSVP or grab your spot before they fill.
        </p>
      </div>
    </div>
    <div class="events-grid">
      {
        upcomingEvents.length ? (
          upcomingEvents.map((event) => (
            <article
              class={`luxe-card event-card${event.featured ? " is-featured" : ""}`}
            >
              {event.heroImageUrl && (
                <div class="event-card__media">
                  <img
                    src={event.heroImageUrl}
                    alt={`${event.title} artwork`}
                    loading="lazy"
                    decoding="async"
                    style={
                      event.heroImageLqip
                        ? {
                            backgroundImage: `url(${event.heroImageLqip})`,
                            backgroundSize: "cover",
                          }
                        : undefined
                    }
                  />
                </div>
              )}
              <div class="event-card__body">
                <div class="event-card__meta">
                  <span class="event-card__date">{event.displayDate}</span>
                  {event.location && (
                    <span class="event-card__location">{event.location}</span>
                  )}
                </div>
                <h3>{event.title}</h3>
                {event.descriptionHtml && (
                  <div
                    class="event-card__description"
                    set:html={event.descriptionHtml}
                  />
                )}
                <div class="event-card__actions">
                  {event.ctaLabel && event.ctaUrl && (
                    <a
                      href={event.ctaUrl}
                      class="btn-cta"
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      {event.ctaLabel}
                    </a>
                  )}
                  <a
                    href={NEETOCAL_EMBED}
                    class="btn-outline"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    Book via NeetoCal
                  </a>
                </div>
              </div>
            </article>
          ))
        ) : (
          <article class="luxe-card">
            <p class="text-white/70">
              No upcoming events scheduled—follow us on Instagram for flash
              updates and pop-up announcements.
            </p>
          </article>
        )
      }
    </div>
  </section>

  <section class="section-block">
    <div class="section-header">
      <span class="section-label">Calendar</span>
      <div>
        <h2 class="section-heading">{monthNames[month]} {year}</h2>
        <p class="section-subhead">
          Track flash days, guest artist residencies, and studio closures. Tap
          any day to start booking through NeetoCal.
        </p>
      </div>
    </div>
    <div class="luxe-card calendar-shell">
      <div class="calendar-nav">
        <a class="btn-outline" href={`?m=${prevMonth}&y=${prevYear}`}>
          <span aria-hidden="true">←</span>
          Previous
        </a>
        <a
          class="btn-outline"
          href={`?m=${now.getMonth()}&y=${now.getFullYear()}`}
        >
          Today
        </a>
        <a class="btn-outline" href={`?m=${nextMonth}&y=${nextYear}`}>
          Next
          <span aria-hidden="true">→</span>
        </a>
      </div>
      <div class="calendar-grid calendar-grid--labels">
        <span>Sun</span>
        <span>Mon</span>
        <span>Tue</span>
        <span>Wed</span>
        <span>Thu</span>
        <span>Fri</span>
        <span>Sat</span>
      </div>
      <div class="calendar-grid">
        {
          cells.map((cell) =>
            cell.isCurrentMonth ? (
              <a
                href={NEETOCAL_EMBED}
                target="_blank"
                rel="noopener noreferrer"
                class={`calendar-cell${cell.isToday ? " is-today" : ""}${cell.holiday ? " is-holiday" : ""}`}
              >
                <span class="calendar-date">{cell.day}</span>
                {cell.holiday && (
                  <span class="calendar-note">{cell.holiday}</span>
                )}
                <span class="calendar-cta">Book</span>
              </a>
            ) : (
              <span class="calendar-cell is-muted">
                <span class="calendar-date">{cell.day}</span>
              </span>
            ),
          )
        }
      </div>
    </div>
  </section>

  {
    recentEvents.length > 0 && (
      <section class="section-block">
        <div class="luxe-card event-archive">
          <h3>Recent highlights</h3>
          <ul>
            {recentEvents.map((event) => (
              <li>
                <span>{event.displayDate}</span>
                <span>{event.title}</span>
              </li>
            ))}
          </ul>
        </div>
      </section>
    )
  }

  <section class="section-block">
    <div class="section-header">
      <span class="section-label">Partners</span>
      <div>
        <h2 class="section-heading">Community Collaborators</h2>
        <p class="section-subhead">
          We love teaming up with local organizations that focus on wellness,
          mental health, and creative expression.
        </p>
      </div>
    </div>
    <div class="partner-grid">
      {
        partners.map((p) => (
          <article class="luxe-card partner-card">
            <div class="partner-card__header">
              <img src={p.logo} alt={`${p.name} logo`} loading="lazy" />
              <h3>
                <a href={p.url} target="_blank" rel="noopener">
                  {p.name}
                </a>
              </h3>
            </div>
            <ul class="partner-card__meta">
              {p.address.map((line) => (
                <li>{line}</li>
              ))}
            </ul>
            <div class="partner-card__contact">
              <span>
                Phone:{" "}
                <a href={`tel:${p.phone.replace(/[^0-9]/g, "")}`}>{p.phone}</a>
              </span>
              <span>
                Email: <a href={`mailto:${p.email}`}>{p.email}</a>
              </span>
            </div>
          </article>
        ))
      }
    </div>
  </section>
</BaseLayout>
