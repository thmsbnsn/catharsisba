---
import BaseLayout from "../layouts/BaseLayout.astro";
import Gallery from "../components/Gallery.jsx";
import { getCollection } from "astro:content";
import { getPageSettings, urlForImage } from "../lib/sanity";

type ManifestImage = {
  path: string;
  folder: string;
  width?: number;
  height?: number;
};

type HeroCta = {
  label: string;
  href: string;
};

// Load all artists
const artists = await getCollection("artists");

// Helper: load manifest per slug
async function loadManifest(slug: string): Promise<ManifestImage[]> {
  try {
    const mod = await import(`../../image-manifests/${slug}.json`);
    return mod.default;
  } catch {
    return [];
  }
}

// Build array of artist + profile image
const artistData = [];
for (const a of artists) {
  const slug = a.slug;
  const manifest = await loadManifest(slug);
  const hero =
    manifest.find((img) => img.folder.includes("profile-images")) ||
    manifest[0] ||
    null;

  artistData.push({
    slug,
    ...a.data,
    hero,
  });
}

const pageSettings = await getPageSettings("index");
const heroImageBuilder = urlForImage(pageSettings?.heroMedia);
const HERO_BG_DEFAULT = "/images/webpages/landinghero1.webp";
const heroBackground =
  heroImageBuilder?.width(2400).height(1600).fit("crop").auto("format").url() ??
  pageSettings?.heroMedia?.asset?.url ??
  HERO_BG_DEFAULT;
const heroOverlay =
  pageSettings?.backgroundOverlay ??
  "linear-gradient(180deg, rgba(8,7,7,0.88) 0%, rgba(8,7,7,0.65) 55%, rgba(8,7,7,0.92) 100%)";
const heroTitle = pageSettings?.heroTitle ?? "Release Through Artistry";
const heroSubtitle =
  pageSettings?.heroSubtitle ??
  "Upscale tattoo and piercing sessions inside a studio that obsesses over detail, safety, and soul. Step in with a vision—leave with catharsis.";
const heroCta: HeroCta =
  pageSettings?.cta && pageSettings.cta.label && pageSettings.cta.href
    ? pageSettings.cta
    : { label: "Book Consultation", href: "/contact" };
---

<BaseLayout
  title="Catharsis Body Art"
  description="Tattoo & Piercing in Brownsburg — modern, precise, calm."
>
  <!-- HERO -->
  <section
    class="hero-viewport"
    style={`--hero-image:url('${heroBackground}'); --hero-overlay:${heroOverlay};`}
  >
    <div class="hero-viewport__content">
      <div class="hero-viewport__copy">
        <span class="hero-pretitle">Catharsis Body Art · Brownsburg, IN</span>
        <h1 class="hero-title">{heroTitle}</h1>
        <p class="hero-subtitle">
          {heroSubtitle}
        </p>

        <div class="hero-actions">
          <a
            href={heroCta.href}
            class="btn-cta hero-action-primary"
            target={heroCta.href.startsWith("http") ? "_blank" : undefined}
            rel={heroCta.href.startsWith("http")
              ? "noopener noreferrer"
              : undefined}
          >
            {heroCta.label}
          </a>
          <a href="#artists" class="btn-outline hero-action-secondary">
            Browse Artists
          </a>
        </div>

        <ul class="hero-metrics" aria-label="Studio highlights">
          <li>
            <span class="metric-label">Piercing Walk-ins</span>
            <span class="metric-value">Welcomed daily</span>
          </li>
          <li>
            <span class="metric-label">Studio Finish</span>
            <span class="metric-value">Medical-grade sterilization</span>
          </li>
        </ul>
      </div>

      <aside class="hero-definition" aria-label="Catharsis definition">
        <span class="definition-term">cath·ar·sis</span>
        <span class="definition-pronounce">(kə-ˈthär-səs)</span>
        <p class="definition-body">
          The release that comes from transforming your story into something
          worn with pride. Every session is a ritual of care, intention, and
          precision.
        </p>
        <div class="definition-footer">
          <span class="glow-dot" aria-hidden="true"></span>
          <span>Honoring your narrative since 2021</span>
        </div>
      </aside>
    </div>

    <a href="#artists" class="hero-scroll" aria-label="Scroll to artists">
      <span>Scroll</span>
    </a>
  </section>

  <!-- MEET THE ARTISTS -->
  <section id="artists" class="section-block">
    <div class="section-header">
      <span class="section-label">01</span>
      <div>
        <h2 class="section-heading">Meet the Artists</h2>
        <p class="section-subhead">
          The humans behind the needles—meticulous, intuitive, and obsessed with
          your comfort.
        </p>
      </div>
    </div>

    <div class="artist-grid">
      {
        artistData.map((artist) => {
          const heroImage =
            artist.hero?.path ??
            artist.hero ??
            "/images/branding/cba-logo-nobackground.webp";
          const summary = artist.bio
            ? `${artist.bio.split(" ").slice(0, 26).join(" ")}${artist.bio.split(" ").length > 26 ? "…" : ""}`
            : "Custom artistry tailored to your story.";

          return (
            <article class="artist-luxe" data-artist={artist.slug}>
              <div class="artist-avatar">
                <div class="artist-avatar__frame">
                  <img
                    src={heroImage}
                    alt={`${artist.name} portrait`}
                    loading="lazy"
                    decoding="async"
                  />
                </div>
              </div>
              <div class="artist-meta">
                {artist.styles && artist.styles.length > 0 && (
                  <span class="artist-style">{artist.styles.join(" · ")}</span>
                )}
                <h3 class="artist-name">{artist.name}</h3>
                <p class="artist-bio">{summary}</p>
              </div>
              <div class="artist-actions">
                <a href={`/artists/${artist.slug}/`} class="btn-outline">
                  View Profile
                </a>
              </div>
            </article>
          );
        })
      }
    </div>
  </section>

  <!-- GALLERY TEASER -->
  <section class="section-block">
    <div class="section-header">
      <span class="section-label">02</span>
      <div>
        <h2 class="section-heading">Gallery</h2>
        <p class="section-subhead">
          A glimpse of recent work—precision line work, luxury piercings, and
          healed pieces.
        </p>
      </div>
    </div>
    <div class="luxe-card">
      <Gallery client:load />
    </div>
  </section>

  <!-- COMMUNITY SUPPORT -->
  <section class="section-block">
    <div class="section-header">
      <span class="section-label">03</span>
      <div>
        <h2 class="section-heading">Community Care</h2>
        <p class="section-subhead">
          With SNAP benefits paused, we’re rallying to keep households stocked. Share the message, grab supplies, or volunteer alongside us.
        </p>
      </div>
    </div>

    <div class="luxe-card community-card">
      <div class="community-copy">
        <p>
          We’re partnering with local food banks and neighbors to assemble care packages, organize drop-offs, and make sure no one goes hungry during the shutdown.
          Every donation or extra set of hands amplifies the impact.
        </p>
        <ul>
          <li>Pick up pantry staples and hygiene kits at the studio</li>
          <li>Register to deliver to families who can’t travel</li>
          <li>Spread the word so anyone in need knows where to find help</li>
        </ul>
        <a href="/contact" class="btn-outline">Offer Support</a>
      </div>
      <div class="community-embed">
        <iframe
          title="Catharsis Body Art community support reel"
          loading="lazy"
          src="https://www.facebook.com/plugins/video.php?height=650&href=https%3A%2F%2Fwww.facebook.com%2Freel%2F1140637124856449%2F&show_text=false&width=400&t=0"
          style="border: none; overflow: hidden;"
          scrolling="no"
          frameborder="0"
          allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"
          allowfullscreen
        ></iframe>
      </div>
    </div>
  </section>

  <!-- MERCHANDISE SHOWCASE -->
  <section class="section-block">
    <div class="section-header">
      <span class="section-label">04</span>
      <div>
        <h2 class="section-heading">Studio Merchandise</h2>
        <p class="section-subhead">
          Limited drops that travel the Catharsis ethos beyond the studio walls.
        </p>
      </div>
    </div>

    <div class="luxe-card merch-grid">
      <div class="merch-visual">
        <img
          src="/images/studio/CBA_MerchBlackTShirt.jpg"
          alt="You Matter - Catharsis Body Art T-Shirt"
          loading="lazy"
          decoding="async"
        />
        <span class="merch-badge">New</span>
      </div>
      <div class="merch-copy">
        <h3>"You Matter" T-Shirt</h3>
        <p>
          A wearable reminder of the affirmation we give every guest. Soft,
          durable, and screen-printed locally.
        </p>
        <ul>
          <li>Premium cotton blend</li>
          <li>Unisex tailored fit</li>
          <li>Sizes XS — 3XL</li>
        </ul>
        <blockquote>
          “Every design we release honors the stories we’re trusted with. You
          matter when you walk in, and long after you leave.”
        </blockquote>
        <div class="merch-actions">
          <a href="tel:+13172867092" class="btn-cta">Call to inquire</a>
          <a href="/our-studio" class="btn-outline">Visit the studio</a>
        </div>
      </div>
    </div>
  </section>

  <!-- BOOKING CTA BAND -->
  <section class="section-block">
    <div class="cta-banner">
      <div class="cta-banner__content">
        <h2>Ready when you are.</h2>
        <p>
          Secure a consult for tattoos or piercings. We’ll map lighting,
          jewelry, and healing before needles ever touch skin.
        </p>
      </div>
      <a href="/contact" class="btn-cta" data-open-contact="true"> Book Now </a>
    </div>
  </section>

  <!-- AFTERCARE + CONTACT TEASERS -->
  <section class="section-block split-grid">
    <article class="resource-card">
      <header>
        <span class="section-label">05</span>
        <h3>Aftercare</h3>
      </header>
      <p>
        Keep your new work pristine. Follow our step-by-step guide for
        cleansing, hydration, and when to reach out.
      </p>
      <a class="btn-outline" href="/aftercare"> View Aftercare Guide </a>
    </article>
    <article class="resource-card">
      <header>
        <span class="section-label">06</span>
        <h3>Visit or call</h3>
      </header>
      <p>
        5801 N. Green St. Suite 106, Brownsburg, IN 46112<br />
        <a href="tel:+13172867092" class="resource-link">(317) 286-7092</a>
      </p>
      <a href="/contact" class="btn-outline"> Open Contact Page </a>
    </article>
  </section>
</BaseLayout>
