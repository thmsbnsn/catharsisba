---
import BaseLayout from "../layouts/BaseLayout.astro";
import Gallery from "../components/Gallery.jsx";
import { getCollection } from "astro:content";
import {
  getAllArtists,
  getBlogPosts,
  getPageSettings,
  urlForImage,
} from "../lib/sanity";

type ManifestImage = {
  path: string;
  folder: string;
  width?: number;
  height?: number;
};

type HeroCta = {
  label: string;
  href: string;
};

type SanityImageAsset = {
  asset?: {
    _ref?: string;
    url?: string;
    metadata?: {
      lqip?: string;
      dimensions?: { width?: number; height?: number };
    };
  };
  crop?: Record<string, unknown>;
  hotspot?: Record<string, unknown>;
  alt?: string;
};

type ArtistListItem = {
  name: string;
  slug: string;
  position?: string;
  shortBio?: string;
  bio?: string;
  styles?: string[];
  profileImage?: SanityImageAsset;
};

type ProcessedArtist = {
  slug: string;
  name: string;
  label?: string;
  summary: string;
  profileImageUrl: string | null;
  profileImageAlt: string;
  profileImageLqip?: string;
};

type BlogPostSummary = {
  title: string;
  slug: string;
  excerpt?: string;
  author?: string;
  publishedAt?: string;
  coverImage?: SanityImageAsset;
  category?: {
    title?: string;
    slug?: string;
    color?: string;
  };
};

function buildImageUrl(
  image: SanityImageAsset | undefined,
  options: {
    width?: number;
    height?: number;
    quality?: number;
    fit?: "crop" | "clip" | "fill";
  } = {},
) {
  if (image?.asset?._ref) {
    let builder = urlForImage(image);
    if (!builder) return undefined;
    if (options.width) builder = builder.width(options.width);
    if (options.height) builder = builder.height(options.height);
    if (options.quality) builder = builder.quality(options.quality);
    if (options.fit) builder = builder.fit(options.fit);
    return builder.auto("format").url();
  }
  return image?.asset?.url;
}

async function loadManifest(slug: string): Promise<ManifestImage[]> {
  try {
    const mod = await import(`../../image-manifests/${slug}.json`);
    return mod.default;
  } catch {
    return [];
  }
}

let rawArtists: ArtistListItem[] = [];
try {
  rawArtists = (await getAllArtists()) as ArtistListItem[];
} catch (error) {
  console.warn(
    "[home] Failed to fetch artists from Sanity, falling back to local content.",
    error,
  );
}

if (!rawArtists?.length) {
  const contentArtists = await getCollection("artists");
  rawArtists = [];
  for (const entry of contentArtists) {
    const manifest = await loadManifest(entry.slug);
    const hero =
      manifest.find((img) => img.folder.includes("profile-images")) ||
      manifest[0] ||
      null;
    rawArtists.push({
      name: entry.data.name,
      slug: entry.slug,
      position: entry.data.styles?.[0] ?? "Artist",
      shortBio: entry.data.bio,
      bio: entry.data.bio,
      styles: entry.data.styles ?? [],
      profileImage: hero
        ? {
            asset: {
              url: hero.path,
              metadata: {
                dimensions: {
                  width: hero.width ?? 1600,
                  height: hero.height ?? 1067,
                },
              },
            },
          }
        : entry.data.hero
          ? { asset: { url: entry.data.hero } }
          : undefined,
    });
  }
}

const artistData: ProcessedArtist[] = rawArtists.map((artist) => {
  const profileImageUrl =
    buildImageUrl(artist.profileImage, {
      width: 640,
      height: 640,
      fit: "crop",
    }) ?? artist.profileImage?.asset?.url ?? null;
  const summarySource = artist.shortBio || artist.bio || "";
  const summary =
    summarySource.length > 220
      ? `${summarySource.slice(0, 217)}…`
      : summarySource;
  const label =
    artist.position ||
    (artist.styles && artist.styles.length > 0
      ? artist.styles.join(" · ")
      : undefined);
  return {
    slug: artist.slug,
    name: artist.name,
    label,
    summary:
      summary ||
      "Custom artistry tailored to your story. Consult to shape your session.",
    profileImageUrl,
    profileImageAlt: `${artist.name} portrait`,
    profileImageLqip: artist.profileImage?.asset?.metadata?.lqip,
  };
});

let blogPostsRaw: BlogPostSummary[] = [];
try {
  blogPostsRaw = (await getBlogPosts()) as BlogPostSummary[];
} catch (error) {
  console.warn("[home] Failed to fetch blog posts from Sanity.", error);
}

const blogHighlights = (blogPostsRaw ?? [])
  .filter((post) => post?.slug)
  .slice(0, 3)
  .map((post) => {
    const coverBuilder = urlForImage(post.coverImage);
    const coverImageUrl =
      coverBuilder
        ?.width(900)
        .height(600)
        .fit("crop")
        .auto("format")
        .url() ?? post.coverImage?.asset?.url ?? "";
    const coverImageLqip = post.coverImage?.asset?.metadata?.lqip ?? "";
    const formattedDate = post.publishedAt
      ? new Date(post.publishedAt).toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        })
      : "";
    return {
      ...post,
      coverImageUrl,
      coverImageLqip,
      formattedDate,
    };
  });

const pageSettings = await getPageSettings("index");
const heroImageBuilder = urlForImage(pageSettings?.heroMedia);
const HERO_BG_DEFAULT = "/images/webpages/landinghero1.webp";
const heroBackground =
  heroImageBuilder?.width(2400).height(1600).fit("crop").auto("format").url() ??
  pageSettings?.heroMedia?.asset?.url ??
  HERO_BG_DEFAULT;
const heroOverlay =
  pageSettings?.backgroundOverlay ??
  "linear-gradient(180deg, rgba(8,7,7,0.88) 0%, rgba(8,7,7,0.65) 55%, rgba(8,7,7,0.92) 100%)";
const heroTitle =
  pageSettings?.heroTitle ??
  "More Than Ink Therapy – This is Release.";
const heroSubtitle =
  pageSettings?.heroSubtitle ??
  "Upscale tattoo and piercing sessions inside a studio that obsesses over detail, safety, and soul. Step in with a vision—leave with catharsis.";
const heroCta: HeroCta =
  pageSettings?.cta && pageSettings.cta.label && pageSettings.cta.href
    ? pageSettings.cta
    : { label: "Book Consultation", href: "/contact" };
---

<BaseLayout
  title="Catharsis Body Art"
  description="Tattoo & Piercing in Brownsburg — modern, precise, calm."
>
  <!-- HERO -->
  <section
    class="hero-viewport"
    style={`--hero-image:url('${heroBackground}'); --hero-overlay:${heroOverlay};`}
  >
    <div class="hero-viewport__content">
      <div class="hero-viewport__copy">
        <span class="hero-pretitle">Catharsis Body Art · Brownsburg, IN</span>
        <h1 class="hero-title">{heroTitle}</h1>
        <p class="hero-subtitle">
          {heroSubtitle}
        </p>

        <div class="hero-actions">
          <a
            href={heroCta.href}
            class="btn-cta hero-action-primary"
            target={heroCta.href.startsWith("http") ? "_blank" : undefined}
            rel={heroCta.href.startsWith("http")
              ? "noopener noreferrer"
              : undefined}
          >
            {heroCta.label}
          </a>
          <a href="#artists" class="btn-outline hero-action-secondary">
            Browse Artists
          </a>
        </div>

        <ul class="hero-metrics" aria-label="Studio highlights">
          <li>
            <span class="metric-label">Piercing Walk-ins</span>
            <span class="metric-value">Welcomed daily</span>
          </li>
          <li>
            <span class="metric-label">Studio Finish</span>
            <span class="metric-value">Medical-grade sterilization</span>
          </li>
        </ul>
      </div>

      <aside class="hero-definition" aria-label="Catharsis definition">
        <span class="definition-term">cath·ar·sis</span>
        <span class="definition-pronounce">(kə-ˈthär-səs)</span>
        <p class="definition-body">
          The release that comes from transforming your story into something
          worn with pride. Every session is a ritual of care, intention, and
          precision.
        </p>
        <div class="definition-footer">
          <span class="glow-dot" aria-hidden="true"></span>
          <span>Honoring your narrative since 2021</span>
        </div>
      </aside>
    </div>

    <a href="#artists" class="hero-scroll" aria-label="Scroll to artists">
      <span>Scroll</span>
    </a>
  </section>

  <!-- MEET THE ARTISTS -->
  <section id="artists" class="section-block">
    <div class="section-header">
      <div>
        <h2 class="section-heading">Meet the Artists</h2>
        <p class="section-subhead">
          The humans behind the needles—meticulous, intuitive, and obsessed with
          your comfort.
        </p>
      </div>
    </div>

    <div class="artist-grid">
      {artistData.map((artist) => (
        <article class="artist-luxe" data-artist={artist.slug}>
          <div class="artist-avatar">
            <div class="artist-avatar__frame">
              {
                artist.profileImageUrl ? (
                  <img
                    src={artist.profileImageUrl}
                    alt={artist.profileImageAlt}
                    loading="lazy"
                    decoding="async"
                    style={
                      artist.profileImageLqip
                        ? { backgroundImage: `url(${artist.profileImageLqip})` }
                        : undefined
                    }
                  />
                ) : (
                  <div class="artist-avatar__fallback">
                    {artist.name.slice(0, 2).toUpperCase()}
                  </div>
                )
              }
            </div>
          </div>
          <div class="artist-meta">
            {artist.label && <span class="artist-style">{artist.label}</span>}
            <h3 class="artist-name">{artist.name}</h3>
            <p class="artist-bio">{artist.summary}</p>
          </div>
          <div class="artist-actions">
            <a href={`/artists/${artist.slug}/`} class="btn-outline">
              View Profile
            </a>
          </div>
        </article>
      ))}
    </div>
  </section>

  {
    blogHighlights.length > 0 && (
      <section class="section-block">
        <div class="section-header">
          <div>
            <h2 class="section-heading">Studio Stories</h2>
            <p class="section-subhead">
              Latest essays, aftercare wisdom, and community spotlights direct
              from the team.
            </p>
          </div>
          <a class="btn-outline" href="/blog">
            View all posts
          </a>
        </div>
        <div class="blog-grid">
          {blogHighlights.map((post) => {
            const accentColor = post.category?.color ?? "#CBA774";
            const accentStyle = `--accent-color:${accentColor};`;
            const coverStyle = post.coverImageLqip
              ? `background-image:url('${post.coverImageLqip}');`
              : undefined;
            return (
              <article class="blog-card" style={accentStyle}>
                <a
                  href={`/blog/${post.slug}/`}
                  class="blog-card__image"
                  aria-label={`Read ${post.title}`}
                  style={coverStyle}
                >
                  {post.coverImageUrl && (
                    <img
                      src={post.coverImageUrl}
                      alt={post.coverImage?.alt || post.title}
                      loading="lazy"
                      decoding="async"
                    />
                  )}
                  <span class="blog-card__image-overlay" />
                </a>
                <div class="blog-card__content">
                  {post.category?.title && (
                    <span class="blog-card__category" style={accentStyle}>
                      {post.category.title}
                    </span>
                  )}
                  <h3 class="blog-card__title">
                    <a href={`/blog/${post.slug}/`}>{post.title}</a>
                  </h3>
                  {post.excerpt && (
                    <p class="blog-card__excerpt">{post.excerpt}</p>
                  )}
                  <div class="blog-card__meta">
                    {post.author && <span>{post.author}</span>}
                    {post.formattedDate && <span>{post.formattedDate}</span>}
                  </div>
                  <a class="blog-card__cta" href={`/blog/${post.slug}/`}>
                    Read Story
                  </a>
                </div>
              </article>
            );
          })}
        </div>
      </section>
    )
  }

  <!-- GALLERY TEASER -->
  <section class="section-block">
    <div class="section-header">
      <div>
        <h2 class="section-heading">Gallery</h2>
        <p class="section-subhead">
          A glimpse of recent work—precision line work, luxury piercings, and
          healed pieces.
        </p>
      </div>
    </div>
    <div class="luxe-card">
      <Gallery client:load />
    </div>
  </section>

  <!-- COMMUNITY SUPPORT -->
  <section class="section-block">
    <div class="section-header">
      <div>
        <h2 class="section-heading">Community Care</h2>
        <p class="section-subhead">
          With SNAP benefits paused, we’re rallying to keep households stocked. Share the message, grab supplies, or volunteer alongside us.
        </p>
      </div>
    </div>

    <div class="luxe-card community-card">
      <div class="community-media">
        <div class="community-video">
          <iframe
            class="community-video__iframe"
            title="Catharsis Body Art community support reel"
            loading="lazy"
            src="https://www.facebook.com/plugins/video.php?height=476&href=https%3A%2F%2Fwww.facebook.com%2Freel%2F1140637124856449%2F&show_text=false&width=848&t=0"
            frameborder="0"
            scrolling="no"
            allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"
            allowfullscreen
          ></iframe>
        </div>
      </div>
      <div class="community-copy">
        <p>
          We’re partnering with local food banks and neighbors to assemble care packages, organize drop-offs, and make sure no one goes hungry during the shutdown.
          Every donation or extra set of hands amplifies the impact.
        </p>
        <ul>
          <li>Pick up pantry staples and hygiene kits at the studio</li>
          <li>Register to deliver to families who can’t travel</li>
          <li>Spread the word so anyone in need knows where to find help</li>
        </ul>
        <div class="community-actions">
          <a href="tel:+13172867092" class="btn-cta">Call Now</a>
          <a href="/contact" class="btn-outline btn-outline--soft">Offer Support</a>
        </div>
      </div>
    </div>
  </section>

  <!-- MERCHANDISE SHOWCASE -->
  <section class="section-block">
    <div class="section-header">
      <div>
        <h2 class="section-heading">Studio Merchandise</h2>
        <p class="section-subhead">
          Limited drops that travel the Catharsis ethos beyond the studio walls.
        </p>
      </div>
    </div>

    <div class="luxe-card merch-grid">
      <div class="merch-visual">
        <img
          src="/images/studio/CBA_MerchBlackTShirt.jpg"
          alt="You Matter - Catharsis Body Art T-Shirt"
          loading="lazy"
          decoding="async"
        />
        <span class="merch-badge">New</span>
      </div>
      <div class="merch-copy">
        <h3>"You Matter" T-Shirt</h3>
        <p>
          A wearable reminder of the affirmation we give every guest. Soft,
          durable, and screen-printed locally.
        </p>
        <ul>
          <li>Premium cotton blend</li>
          <li>Unisex tailored fit</li>
          <li>Sizes XS — 3XL</li>
        </ul>
        <blockquote>
          “Every design we release honors the stories we’re trusted with. You
          matter when you walk in, and long after you leave.”
        </blockquote>
        <div class="merch-actions">
          <a href="tel:+13172867092" class="btn-cta">Call to inquire</a>
          <a href="/our-studio" class="btn-outline">Visit the studio</a>
        </div>
      </div>
    </div>
  </section>

  <!-- BOOKING CTA BAND -->
  <section class="section-block">
    <div class="cta-banner">
      <div class="cta-banner__content">
        <h2>Ready when you are.</h2>
        <p>
          Secure a consult for tattoos or piercings. We’ll map lighting,
          jewelry, and healing before needles ever touch skin.
        </p>
      </div>
      <a href="/contact" class="btn-cta" data-open-contact="true"> Book Now </a>
    </div>
  </section>

  <!-- AFTERCARE + CONTACT TEASERS -->
  <section class="section-block split-grid">
    <article class="resource-card">
      <header>
        <h3>Aftercare</h3>
      </header>
      <p>
        Keep your new work pristine. Follow our step-by-step guide for
        cleansing, hydration, and when to reach out.
      </p>
      <a class="btn-outline" href="/aftercare"> View Aftercare Guide </a>
    </article>
    <article class="resource-card">
      <header>
        <h3>Visit or call</h3>
      </header>
      <p>
        5801 N. Green St. Suite 106, Brownsburg, IN 46112<br />
        <a href="tel:+13172867092" class="resource-link">(317) 286-7092</a>
      </p>
      <a href="/contact" class="btn-outline"> Open Contact Page </a>
    </article>
  </section>
</BaseLayout>
